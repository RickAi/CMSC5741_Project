{% extends 'base.html' %}

{% block title %}
名人图片相识查找
{% endblock %}
{% block content %}
<div class="container" style="margin-top:30px">
    <div class="row">
        <div class="col-sm-4">
            <h2>Try!</h2>
            <!-- <h5>Photo you upload:</h5> -->
            <!-- <img  class="img-responsive"></img> -->
            <div class="card" style="width:auto">
                <img class="card-img-top" id='origin_img' src="/static/images/img_avatar1.png" style="width:100%">
                <div class="card-body">
                    <h4 class="card-title">Photo you upload</h4>
                    <form id='image-form' method="POST">
                        {% csrf_token %}
                        <input type="file" class="form-control-file border" name="img" onchange="showPreview(this)" alt="Upload" />
                        <br>
                        <input type="submit" class="btn btn-primary" name="submit" value="Search" />
                    </form>
                </div>
            </div>
        </div>
        <div class="col-sm-8">
            <h2>Search Results</h2>
            <h5>TOP 5</h5>
            <div id='result'>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script type="text/javascript" src="/static/js/jquery.cookie.js"></script>
<script type="text/javascript">
    function showPreview(source) {
        var file = source.files[0];
        if (window.FileReader) {
            var fr = new FileReader();
            fr.onloadend = function (e) {
                $('#origin_img').attr('src', e.target.result);
            }
            fr.readAsDataURL(file);
        }
    }
    $('#image-form').submit(function () {
        var file_obj = $("input[name='img']")[0].files[0];
        $('#suc').text('kadsf')
        var form_obj = new FormData();
        form_obj.append("img", file_obj);
        $.ajaxSetup({                     //设置csrf_token
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", $.cookie("csrftoken"));
            }
        });
        $.ajax({
            type: "POST",
            url: "{% url 'upload' %}",
            data: form_obj,
            processData: false,
            contentType: false,
            success: function (data) {
                if (data['status'] == "fail") {
                    alert("Don't find face in the image!");
                }
                else if (data['status'] == "success") {
                    console.log(data)
                    if (data['query_results'].length == 0) {
                        alert("No similar celebrity in our database!");
                        return false;
                    }
                    addImages('result', data['query_results'].length);
                    var i = 0;
                    data['query_results'].forEach(elem => {
                        $("#img" + i).attr('src', elem['path']);
                        i++;
                    });
                }
            }
        });
        return false;
    });

    function addImages(id, num) {
        $('#' + id).empty();
        for (var i = 0; i < num; i++) {
            if(i%3==0){
                var row = $("<div class='row'></div>");
            }
            var div = $("<div class='col-xs-6 col-md-4'><a class='thumbnail'>");
            var img = $("<img id='img" + (i) + "' class='img-responsive' style='height: 200px; width: 100%;'/>");
            img.appendTo(div);
            div.appendTo(row);
            if((i+1)%3==0 || (i+1)==num ){
                row = row.appendTo($("<div class='bs-example' data-example-id='simple-thumbnails'></div>"));
                row.appendTo($("#result"));
                $("<br>").appendTo($("#result"));
            }
        }
    };
</script>
{% endblock %}